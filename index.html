<!DOCTYPE html>
<html>
  <head> </head>
  <body style="margin:0px;overflow:hidden;">
    <div id="game">
      <div id="hud" style="display:none;">
        <div
          style="position:absolute;left:20px;bottom:20px;font-family:arial;font-size:30px;color:#ffff00;"
        >
          +<span id="health">100</span>
        </div>
      </div>
      <div id="stat" style="position:absolute;"></div>
      <div
        id="loading"
        style="position:absolute;display:block;top:50%;width:100%;text-align:center;font-family:arial;font-size:20px;color:#ffff00;"
      >
        Loaded <span id="loading_amount"></span>
      </div>
      <div
        id="begin"
        onClick="init_last();"
        style="cursor:pointer;position:absolute;display:none;top:50%;width:100%;text-align:center;font-family:arial;font-size:20px;color:#ffff00;"
      >
        Start
      </div>
      <canvas
        id="canvas"
        width="800"
        height="600"
        style="background:#000000;vertical-align:top;"
      ></canvas>
    </div>

    <audio id="go" preload>
      <source src="audio/go.mp3" type="audio/mpeg" />
    </audio>

    <script type="text/javascript" src="js/three.js"></script>
    <script type="text/javascript" src="js/stats.min.js"></script>
    <script type="text/javascript" src="js/FirstPersonControls.js"></script>
    <script type="text/javascript" src="js/MTLLoader.js"></script>
    <script type="text/javascript" src="js/OBJLoader.js"></script>

    <script type="text/javascript">
      "use strict";

      var scene, camera, renderer, controls;
      var canvas = document.getElementById("canvas");
      var width, height;
      var use_fullscreen = 0; // 0 - fullscreen off, 1 - fullscreen on
      var sens = 1.5; // rotation sensetivity

      if (use_fullscreen == 0) {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      } else {
        var width = screen.width;
        var height = screen.height;
        canvas.width = screen.width;
        canvas.height = screen.height;
      }

      var stop = 1; // break and call function loop();

      // ________________________ Fullscreen________________________

      function fullscreen() {
        var element = document.getElementById("game");
        if (element.requestFullScreen) {
          element.requestFullScreen();
        } else if (element.webkitRequestFullScreen) {
          element.webkitRequestFullScreen();
        } else if (element.mozRequestFullScreen) {
          element.mozRequestFullScreen();
        }
      }

      // ________________________ Mousemove control ________________________

      function lockChangeAlert() {
        if (
          document.pointerLockElement === canvas ||
          document.mozPointerLockElement === canvas
        ) {
          document.addEventListener("mousemove", updatePosition, false);
        } else {
          document.removeEventListener("mousemove", updatePosition, false);
        }
      }

      // ________________________ Turns   ________________________

      var fps_cam_x = 0;
      var fps_cam_y = 0;

      function updatePosition(e, move_x, move_y) {
        if (stop == 1) {
          return;
        }
        fps_cam_x += e.movementX * sens;
        fps_cam_y += e.movementY * sens;
        controls.mouseX = fps_cam_x;
        controls.mouseY = fps_cam_y;
      }

      var stats = new Stats();
      document.getElementById("stat").appendChild(stats.dom);

      var meshes = [];
      var clock = new THREE.Clock();

      camera = new THREE.PerspectiveCamera(60, width / height, 1, 10000);
      camera.position.set(150, 150, 400);
      //camera.lookAt(0,0,0);

      renderer = new THREE.WebGLRenderer({
        canvas: canvas,
        antialias: true,
        alpha: true,
        transparent: true,
        premultipliedAlpha: false
      });
      renderer.setSize(width, height);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setClearColor(0xffffff);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = 0;
      renderer.gammaInput = true;
      renderer.gammaOutput = true;

      controls = new THREE.FirstPersonControls(camera, renderer.domElement);
      controls.movementSpeed = 100;
      controls.lookSpeed = 0.1;
      controls.lookVertical = true;

      scene = new THREE.Scene();

      // ________________________ Axes directions ________________________

      scene.add(new THREE.AxesHelper(100));

      // ________________________ Light environment ________________________

      var ambient = new THREE.AmbientLight(0xf5cf6b, 0.2);
      scene.add(ambient);

      // ________________________ Fog ________________________

      scene.fog = new THREE.Fog(0xffffff, 200, 3000);

      // ________________________ Sun light________________________

      var sun = new THREE.DirectionalLight(0xfffff0, 1.2);
      sun.position.set(400, 450, 500);
      sun.castShadow = true;
      sun.shadow.mapSize.width = 4096;
      sun.shadow.mapSize.height = 4096;
      sun.shadow.camera.near = 10;
      sun.shadow.camera.far = 1700;
      sun.shadow.camera.left = -2000;
      sun.shadow.camera.right = 2000;
      sun.shadow.camera.top = 1350;
      sun.shadow.camera.bottom = -1350;
      sun.shadow.bias = -0.01;
      sun.shadow.radius = 1;
      scene.add(sun);

      scene.add(new THREE.DirectionalLightHelper(sun, 100));

      //__________________ Flying pointed light ______________

      var pointLight = new THREE.PointLight(0xffffff, 2, 800);

      scene.add(pointLight);
      pointLight.add(new THREE.PointLightHelper(pointLight, 10));

      //__________________ Loader _______________

      var manager_to_load = 0; //  How many items need to load. It proccesses below
      var manager_loaded = 0; // Loaded in manager
      var other_to_load = 0; // How many rest files need to load directly. Prosseses below
      var other_loaded = 0; // Loaded directly

      var loadingManager = new THREE.LoadingManager();
      loadingManager.onProgress = function(item, loaded, total) {
        console.log(item, loaded, total);
        manager_loaded = loaded;
        if (loaded == total) {
          console.log("Files in manager were loaded");
        }
      };

      //__________________ Run files loading checking when page is loaded _______________

      window.onload = function() {
        audios = document.getElementsByTagName("audio");
        check_loaded = setTimeout("is_loaded();", 100);
      };

      //__________________ files loading checking _______________

      var audios = [];
      var check_loaded;

      function is_loaded() {
        document.getElementById("loading_amount").innerHTML =
          manager_loaded +
          other_loaded +
          "/" +
          (manager_to_load + other_to_load);
        for (var aui = 0; aui < audios.length; aui++) {
          if (audios[aui].readyState != 4) {
            check_loaded = setTimeout("is_loaded();", 100);
            return;
          }
        }

        if (manager_to_load + other_to_load == manager_loaded + other_loaded) {
          document.getElementById("loading").style.display = "none";
          clearTimeout(check_loaded);
          init_first();
          return;
        }

        check_loaded = setTimeout("is_loaded();", 100);
      }

      //__________________ Fist init after loading _______________

      function init_first() {
        sound["myst"] = new THREE.PositionalAudio(listener);
        sound["myst"].setBuffer(sound_file["myst"]);
        sound["myst"].loop = true;
        sound["myst"].setRefDistance(10); // Distance of sound is 1 meter
        sound["myst"].setVolume(1); //volume
        meshes["ball_w"].add(sound["myst"]); // sound binding for meshes["ball_w"]

        canvas.requestPointerLock =
          canvas.requestPointerLock || canvas.mozRequestPointerLock;
        document.exitPointerLock =
          document.exitPointerLock || document.mozExitPointerLock;
        document.addEventListener("pointerlockchange", lockChangeAlert, false);
        document.addEventListener(
          "mozpointerlockchange",
          lockChangeAlert,
          false
        );

        document.getElementById("begin").style.display = "block";
      }

      //__________________ last init and run ________________________

      function init_last() {
        document.getElementById("begin").style.display = "none";
        document.getElementById("hud").style.display = "block";

        if (use_fullscreen == 1) {
          fullscreen();
          canvas.requestPointerLock();
        }

        document.getElementById("go").play();
        sound["myst"].play();
        stop = 0;
        loop();
      }

      //__________________ sounds _______________

      var sound = [];
      var sound_file = [];

      var listener = new THREE.AudioListener();
      listener.context.resume(); // for bug proccess
      camera.add(listener);
      var audioLoader = new THREE.AudioLoader();

      audioLoader.load("audio/Mystical_theme.mp3", function(buffer) {
        sound_file["myst"] = buffer;
        other_loaded++;
      });
      other_to_load++;

      //__________________ textures _______________

      var maxanisotropy = renderer.capabilities.getMaxAnisotropy(); // Clarity of image

      var tex = [];
      var texture_loader = new THREE.TextureLoader(loadingManager);

        //Material types in the end after _: c - stone, m - metal, g - ground, w - tree, d -device, s - water, a - fruit, f - meat, gg - glass
        //Glass might be able through material property opacity: 0.5
      tex["ground"] = texture_loader.load("images/ground_c.jpg");
      tex["ground"].wrapS = tex["ground"].wrapT = THREE.RepeatWrapping;
      tex["ground"].repeat.set(6, 2);

      tex["terrain"] = texture_loader.load("images/terrain.jpg");
      tex["terrain"].anisotropy = maxanisotropy;
      tex["terrain"].wrapS = tex["terrain"].wrapT = THREE.RepeatWrapping;
      tex["terrain"].repeat.set(16, 16);

      for (var n in tex) {
        manager_to_load++; // Quantity of textures for loading
      }

      //__________________ Sky _______________

      var textureSkyCube = new THREE.CubeTextureLoader(loadingManager)
        .setPath("images/sky/")
        .load(["lf.jpg", "rt.jpg", "up.jpg", "dn.jpg", "ft.jpg", "bk.jpg"]);
      scene.background = textureSkyCube;

      manager_to_load += 6; // adding 6 sky textures

      //__________________ landscape _______________

      other_to_load++;

      var mtlLoader = new THREE.MTLLoader();
      mtlLoader.load("models/terrain.mtl", function(materials) {
        //materials.preload();

        materials.materials.terrain = new THREE.MeshLambertMaterial({
          map: tex["terrain"],
          flatShading: false //  (SMOOTH GROUP)
        });

        var objLoader = new THREE.OBJLoader();

        objLoader.setMaterials(materials);
        objLoader.load("models/terrain.obj", function(object) {
          while (object.children.length) {
            meshes["terrain"] = object.children[0];
            meshes["terrain"].scale.set(2, 2, 2);
            meshes["terrain"].receiveShadow = true;
            meshes["terrain"].position.set(0, 500, 700);
            scene.add(meshes["terrain"]);
          }

          other_loaded++;

          //scene.add(object);
        });
      });

      //__________________ Flour ______________

      meshes["ground"] = new THREE.Mesh(
        new THREE.PlaneBufferGeometry(1600, 500),
        new THREE.MeshStandardMaterial({
          map: tex["ground"],
          bumpMap: tex["ground"],
          roughness: 0.2,
          side: THREE.FrontSide, // two-sides material
          shadowSide: THREE.FrontSide
        })
      );
      meshes["ground"].castShadow = true;
      meshes["ground"].receiveShadow = true;
      meshes["ground"].position.x = 300;
      meshes["ground"].geometry.applyMatrix(
        new THREE.Matrix4().makeRotationX(-90 * (Math.PI / 180))
      );
      meshes["ground"].updateMatrixWorld();
      scene.add(meshes["ground"]);

      //__________________ sphere wireframe ______________

      meshes["ball_w"] = new THREE.Mesh(
        new THREE.SphereBufferGeometry(20, 16, 16),
        new THREE.MeshPhongMaterial({
          color: 0xffff00,
          wireframe: true
        })
      );
      meshes["ball_w"].castShadow = true;
      meshes["ball_w"].position.x = 100;
      meshes["ball_w"].position.y = 50;
      scene.add(meshes["ball_w"]);

      // ________________________ rendering ________________________

      function loop() {
        if (stop == 1) {
          return;
        }

        requestAnimationFrame(loop);

        var delta = clock.getDelta();

        controls.update(delta);

        var timer = Date.now() * 0.00025;

        pointLight.position.x = Math.sin(timer * 5) * 100;
        pointLight.position.y = 20 + Math.cos(timer * 20) * 10;
        pointLight.position.z = Math.cos(timer * 5) * 100;

        renderer.render(scene, camera);

        stats.update();
      }
    </script>
  </body>
</html>
